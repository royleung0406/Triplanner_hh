<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—…éŠå°å¹«æ‰‹</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FEFDF5">
    
    <!-- App Icon -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root { --bg-color: #FEFDF5; --text-main: #433D3C; --text-sub: #9CA3AF; }
        body { font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-main); -webkit-user-select: none; user-select: none; padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .zen-shadow { box-shadow: 0 8px 24px rgba(149, 157, 165, 0.08); border: 1px solid rgba(255,255,255,0.8); }
        .tag-must-eat { background: #FFE4E6; color: #BE123C; } .tag-nav { background: #F3F4F6; color: #374151; } .tag-tips { background: #E0F2FE; color: #0369A1; }
        .active-tab { color: #57534E; font-weight: 700; background-color: #F5F5F4; border-radius: 16px; } .inactive-tab { color: #A8A29E; }
        .tap-effect:active { opacity: 0.8; transform: scale(0.98); transition: transform 0.1s; }
        @keyframes slide-up-spring { 0% { transform: translateY(100%); opacity: 0; } 60% { transform: translateY(-10px); opacity: 1; } 100% { transform: translateY(0); } }
        .modal-enter { animation: slide-up-spring 0.4s ease-out forwards; }
        button, .card-clickable { touch-action: manipulation; cursor: pointer; }
        .share-btn-selected { background-color: #433D3C; color: #FFFFFF; border-color: #433D3C; }
        .share-btn-unselected { background-color: #F5F5F4; color: #A8A29E; border-color: transparent; }
        .filter-btn-active { background-color: rgba(255,255,255,0.2); color: white; font-weight: bold; border: 1px solid rgba(255,255,255,0.4); }
        .filter-btn-inactive { color: rgba(255,255,255,0.6); }
        .weather-scroll-item { min-width: 60px; }
        #sync-indicator { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(67, 61, 60, 0.9); color: white; padding: 6px 16px; border-radius: 20px; font-size: 11px; font-weight: bold; z-index: 9999; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 6px; transition: opacity 0.3s, transform 0.3s; opacity: 0; pointer-events: none; }
        #sync-indicator.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #lock-screen, #access-denied-screen { position: fixed; inset: 0; background: #FEFDF5; z-index: 9990; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #lock-screen.active, #access-denied-screen.active { display: flex; }
        #user-menu { position: absolute; top: 60px; right: 20px; background: white; border-radius: 16px; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 50; display: none; flex-direction: column; gap: 4px; border: 1px solid #eee; min-width: 180px; }
        #user-menu.show { display: flex; }
        #user-avatar.logged-in { border: 2px solid #433D3C; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#FEFDF5]">

    <div id="sync-indicator"><i id="sync-icon" data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i><span id="sync-msg">åŒæ­¥ä¸­...</span></div>

    <!-- VIEW 0: é¦–é  -->
    <div id="view-home" class="h-full flex flex-col p-6 animate-fade-in relative">
        <header class="mb-8 pt-safe-top flex justify-between items-end">
            <div><p class="text-xs text-stone-400 font-bold tracking-widest mb-1">TRAVEL LOG</p><h1 class="text-3xl font-black tracking-wide text-[#433D3C]">æˆ‘çš„æ—…ç¨‹</h1></div>
            <div class="relative">
                <button onclick="toggleUserMenu()" id="user-avatar" class="w-10 h-10 rounded-full bg-stone-200 flex items-center justify-center overflow-hidden tap-effect shadow-md border-2 border-white"><i id="user-icon-default" data-lucide="user" class="w-5 h-5 text-stone-500"></i><img id="user-img" src="" class="w-full h-full object-cover hidden"></button>
                <div id="user-menu">
                    <div id="user-info" class="px-4 py-3 text-xs text-stone-400 border-b border-stone-100 mb-1 hidden">æœªç™»å…¥</div>
                    <button onclick="handleLogin()" id="btn-login" class="px-4 py-3 text-sm font-bold text-stone-700 hover:bg-stone-50 rounded-xl text-left flex items-center gap-3 transition-colors"><div class="w-6 h-6 rounded-full bg-white border border-stone-200 flex items-center justify-center"><i data-lucide="log-in" class="w-3 h-3"></i></div>Google ç™»å…¥</button>
                    <button onclick="handleLogout()" id="btn-logout" class="px-4 py-3 text-sm font-bold text-red-500 hover:bg-red-50 rounded-xl text-left flex items-center gap-3 hidden transition-colors"><div class="w-6 h-6 rounded-full bg-white border border-stone-200 flex items-center justify-center"><i data-lucide="log-out" class="w-3 h-3"></i></div>ç™»å‡º</button>
                </div>
            </div>
        </header>
        <div id="trip-list-container" class="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-24"><div class="text-center text-stone-400 mt-20"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i><p>è¼‰å…¥æ—…ç¨‹ä¸­...</p></div></div>
        <button onclick="createNewTrip()" class="absolute bottom-8 right-6 bg-[#433D3C] text-white w-14 h-14 rounded-full flex items-center justify-center shadow-xl tap-effect z-10"><i data-lucide="plus" class="w-8 h-8"></i></button>
    </div>

    <!-- æ¬Šé™ç•«é¢ -->
    <div id="lock-screen"><div class="w-16 h-16 rounded-full bg-stone-100 flex items-center justify-center mb-6 text-stone-400"><i data-lucide="lock" class="w-8 h-8"></i></div><h2 class="text-2xl font-bold text-[#433D3C] mb-2">æ­¤æ—…ç¨‹å—ä¿è­·</h2><p class="text-sm text-stone-400 mb-6 text-center">è«‹è¼¸å…¥é€šè¡Œç¢¼</p><div class="flex gap-2 mb-6"><input type="text" id="access-code-input" maxlength="4" class="w-32 bg-white text-center text-2xl font-bold tracking-[0.5em] py-3 rounded-2xl border-2 border-stone-100 focus:border-[#433D3C] outline-none" placeholder="â€¢â€¢â€¢â€¢"></div><button onclick="verifyAccessCode()" class="w-full max-w-xs py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg">è§£é–</button><button onclick="backToHome()" class="mt-4 text-sm text-stone-400 underline">è¿”å›é¦–é </button></div>
    <div id="access-denied-screen"><div class="w-16 h-16 rounded-full bg-red-50 flex items-center justify-center mb-6 text-red-400"><i data-lucide="shield-alert" class="w-8 h-8"></i></div><h2 class="text-2xl font-bold text-[#433D3C] mb-2">ç„¡æ¬Šè¨ªå•</h2><p class="text-sm text-stone-400 mb-6 text-center px-6">æ‚¨ä¸åœ¨é‚€è«‹åå–®å…§ã€‚</p><div class="bg-stone-50 px-4 py-2 rounded-lg mb-6 border border-stone-200 text-center"><p class="text-xs text-stone-500 font-mono mb-1">ç›®å‰ç™»å…¥ï¼š</p><p class="text-xs font-bold text-[#433D3C]" id="current-user-email-display">æœªç™»å…¥</p></div><button onclick="claimOwnership()" id="claim-btn" class="w-full max-w-xs py-3 rounded-2xl bg-green-600 text-white font-bold tap-effect shadow-lg mb-3 hidden">ğŸ‘‘ èªé ˜æ­¤è¡Œç¨‹</button><button onclick="handleLogin()" class="w-full max-w-xs py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg mb-3">åˆ‡æ›å¸³è™Ÿ</button><button onclick="backToHome()" class="text-sm text-stone-400 underline">è¿”å›é¦–é </button></div>

    <!-- VIEW 1: è¡Œç¨‹è©³æƒ… -->
    <div id="view-app" class="h-full flex flex-col hidden">
        <header class="bg-[#FEFDF5]/90 backdrop-blur-sm pt-safe-top sticky top-0 z-20 px-6 py-4 flex justify-between items-end border-b border-stone-100/50">
            <div class="flex items-center gap-3">
                <button onclick="backToHome()" class="bg-white w-8 h-8 rounded-full flex items-center justify-center shadow-sm text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <div class="flex-1 min-w-0"><p class="text-[10px] text-gray-400 tracking-widest mb-0.5 font-bold">CURRENT TRIP</p><div class="flex items-center gap-2"><h1 class="text-xl font-bold tracking-wide text-[#433D3C] truncate" id="header-trip-title">æ—…ç¨‹æ¨™é¡Œ</h1><button onclick="openSecurityModal()" class="text-stone-300 hover:text-stone-500 tap-effect p-1 flex-shrink-0"><i id="header-lock-icon" data-lucide="unlock" class="w-4 h-4"></i></button></div></div>
            </div>
            <div class="text-right flex flex-col items-end gap-2">
                <div class="flex gap-2 items-center">
                    <button onclick="openDateModal()" class="text-stone-400 hover:text-stone-600 tap-effect p-1.5 bg-white rounded-full shadow-sm"><i data-lucide="settings-2" class="w-4 h-4"></i></button>
                    <button onclick="window.openShareModal()" class="bg-[#433D3C] text-white px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-1.5 tap-effect shadow-md border border-transparent hover:bg-stone-700 transition-colors"><i data-lucide="user-plus" class="w-3 h-3"></i><span>é‚€è«‹</span></button>
                </div>
                 <div class="flex items-center gap-1 text-gray-600 bg-white px-2 py-1 rounded-lg shadow-sm border border-stone-100"><i data-lucide="thermometer" class="w-3 h-3 text-stone-400"></i><span class="text-xs font-bold" id="header-temp">--Â°C</span></div>
            </div>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar pb-28 relative px-4">
            <div id="view-schedule" class="view-section pt-2 space-y-6 animate-fade-in">
                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1" id="day-selector"></div>
                <div class="bg-white rounded-[24px] p-4 zen-shadow border border-white overflow-hidden">
                    <div class="flex items-center gap-2 mb-3 px-1"><i data-lucide="cloud-sun" class="w-4 h-4 text-blue-400"></i><span class="text-xs font-bold text-stone-500" id="weather-title">å¤©æ°£é å ±</span></div>
                    <div class="flex overflow-x-auto no-scrollbar gap-2" id="hourly-weather-container"><div class="w-full text-center text-stone-300 py-4 text-xs">è¼‰å…¥çœŸå¯¦å¤©æ°£...</div></div>
                </div>
                <div id="timeline-container" class="space-y-4 pb-10"></div>
            </div>
            <div id="view-info" class="view-section hidden pt-4 space-y-6 animate-fade-in">
                <div class="bg-white rounded-[24px] p-6 zen-shadow">
                    <h3 class="text-lg font-bold text-gray-800 mb-5 flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"><i data-lucide="plane-takeoff" class="w-4 h-4"></i></div>èˆªç­è³‡è¨Š</h3>
                    <div class="space-y-6" id="flight-info-placeholder"><div class="p-4 bg-stone-50 rounded-xl text-center text-stone-400 text-sm">å¯åœ¨é€™è£¡åŠ å…¥èˆªç­è³‡è¨ŠåŠŸèƒ½ (å¾…é–‹ç™¼)</div></div>
                </div>
            </div>
            <div id="view-budget" class="view-section hidden pt-4 space-y-6 animate-fade-in">
                <div class="bg-[#2D2A26] rounded-[24px] p-6 text-white zen-shadow relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/5 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start mb-4"><p class="text-stone-400 text-xs font-medium tracking-wide uppercase" id="budget-title">ç¸½æ¶ˆè²» (ALL)</p><button onclick="promptAddCompanion()" class="bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-full text-[10px] flex items-center gap-1 backdrop-blur-sm transition-colors"><i data-lucide="users" class="w-3 h-3"></i> ç®¡ç†æ—…ä¼´</button></div>
                    <div class="mb-6"><div class="flex items-baseline gap-2"><span class="text-lg text-stone-400 font-bold">NT$</span><h2 class="text-5xl font-bold tracking-tighter font-mono" id="total-expense-twd">0</h2></div><p class="text-stone-400 text-sm mt-1 font-medium flex items-center gap-1"><span class="bg-white/10 px-2 py-0.5 rounded text-xs">ç´„ HK$ <span id="total-expense-hkd" class="font-mono">0</span></span></p></div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1" id="member-filter-container"></div>
                </div>
                <div class="bg-white p-5 rounded-[24px] zen-shadow space-y-5 relative overflow-hidden">
                    <h3 class="text-stone-800 font-bold text-lg flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-600"><i data-lucide="receipt" class="w-4 h-4"></i></div> è¨˜ä¸€ç­†</h3>
                    <div class="bg-stone-50 rounded-2xl px-5 py-4 flex flex-col border border-transparent focus-within:border-[#433D3C] transition-all shadow-inner relative group"><label class="text-[10px] text-stone-400 font-bold mb-1 uppercase">é‡‘é¡ (TWD)</label><div class="flex items-baseline"><span class="text-stone-400 text-2xl mr-2 font-bold">$</span><input type="number" id="expense-amount" placeholder="0" class="flex-1 bg-transparent text-4xl focus:outline-none text-stone-800 font-mono font-bold placeholder-stone-200"></div><div class="absolute right-4 top-1/2 -translate-y-1/2 text-stone-300 font-mono text-sm pointer-events-none group-focus-within:text-stone-400 transition-colors">â‰ˆ HK$ <span id="input-hkd-preview">0</span></div></div>
                    <div class="bg-stone-50 rounded-2xl px-4 py-3 flex items-center gap-2 border border-transparent focus-within:border-stone-200 transition-colors"><input type="text" id="expense-item" placeholder="æ¶ˆè²»é …ç›®" class="flex-1 bg-transparent text-base focus:outline-none text-stone-700 placeholder-stone-400 font-medium"></div>
                    <div class="grid grid-cols-1 gap-3 bg-stone-50 p-4 rounded-2xl">
                        <div class="flex items-center justify-between"><span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="wallet" class="w-3 h-3"></i> èª°å…ˆä»˜éŒ¢ï¼Ÿ</span><select id="expense-payer" class="bg-white text-stone-700 text-sm font-bold px-3 py-1.5 rounded-lg border-none focus:ring-0 outline-none cursor-pointer shadow-sm"></select></div>
                        <div class="h-px bg-stone-200/50 w-full"></div>
                        <div class="space-y-2"><div class="flex justify-between items-center"><span class="text-xs text-stone-500 font-bold flex items-center gap-1"><i data-lucide="users" class="w-3 h-3"></i> èª°è¦åˆ†æ”¤ï¼Ÿ</span><button type="button" onclick="selectAllShares()" class="text-[10px] bg-blue-50 text-blue-500 font-bold px-2 py-1 rounded hover:bg-blue-100 transition-colors">å…¨é¸</button></div><div id="share-buttons-container" class="flex flex-wrap gap-2"></div></div>
                    </div>
                    <button onclick="addExpense()" class="w-full bg-[#433D3C] text-white py-4 rounded-2xl flex items-center justify-center gap-2 tap-effect shadow-lg shadow-stone-200 font-bold text-lg active:scale-[0.98] transition-transform"><i data-lucide="plus" class="w-5 h-5"></i> åŠ å…¥è¨˜å¸³</button>
                </div>
                <div class="flex justify-between items-end px-2"><h4 class="text-stone-400 text-xs font-bold tracking-widest uppercase">äº¤æ˜“ç´€éŒ„ (HISTORY)</h4><span class="text-[10px] text-stone-300" id="list-filter-status">é¡¯ç¤ºå…¨éƒ¨</span></div>
                <div id="expense-list" class="space-y-3 pb-10 min-h-[100px]"></div>
            </div>
        </main>
        <div class="fixed bottom-6 left-6 right-6 z-30"><nav class="bg-white/90 backdrop-blur-xl rounded-[24px] shadow-[0_8px_32px_rgba(0,0,0,0.08)] p-2 border border-white/50"><div class="flex justify-around items-center"><button onclick="switchTab('schedule')" id="tab-schedule" class="active-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300"><i data-lucide="map" class="w-5 h-5"></i><span class="text-xs font-bold">è¡Œç¨‹</span></button><button onclick="switchTab('info')" id="tab-info" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300"><i data-lucide="sparkles" class="w-5 h-5"></i><span class="text-xs font-bold hidden">è³‡è¨Š</span></button><button onclick="switchTab('budget')" id="tab-budget" class="inactive-tab flex items-center gap-2 px-4 py-3 tap-effect transition-all duration-300"><i data-lucide="wallet" class="w-5 h-5"></i><span class="text-xs font-bold hidden">è¨˜å¸³</span></button></div></nav></div>
    </div>

    <!-- Modals -->
    <div id="share-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative text-center">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-[#433D3C]">é‚€è«‹æ—…ä¼´</h3><button onclick="closeShareModal()" class="text-stone-400"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="bg-white p-1 rounded-xl border border-stone-200 flex mb-4 shadow-sm"><input type="email" id="invite-email-input" placeholder="è¼¸å…¥ Gmail..." class="flex-1 px-3 py-2 text-sm outline-none rounded-l-xl"><button onclick="inviteUser()" class="bg-[#433D3C] text-white px-4 py-2 rounded-lg text-xs font-bold tap-effect">åŠ å…¥</button></div>
            <div class="mb-6"><p class="text-[10px] text-stone-400 font-bold tracking-widest mb-2 uppercase">èª°æœ‰æ¬Šé™</p><div id="access-list-container" class="space-y-2 max-h-40 overflow-y-auto no-scrollbar"></div></div>
            <hr class="border-stone-100 mb-4">
            <div class="flex gap-2"><button onclick="copyShareLink()" class="flex-1 py-3 rounded-xl bg-stone-100 text-stone-600 font-bold tap-effect flex items-center justify-center gap-2"><i data-lucide="link" class="w-4 h-4"></i> è¤‡è£½é€£çµ</button><button onclick="shareViaGmail()" class="flex-1 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold tap-effect flex items-center justify-center gap-2"><i data-lucide="mail" class="w-4 h-4"></i> Gmail</button></div>
        </div>
    </div>
    <div id="security-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity"><div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative text-center"><h3 class="text-lg font-bold mb-2 text-[#433D3C]">å¯†ç¢¼ä¿è­·</h3><p class="text-xs text-stone-400 mb-6">è¨­å®šå‚™ç”¨é€šè¡Œç¢¼ (çµ¦æœªç™»å…¥è€…ä½¿ç”¨)</p><div class="mb-6"><input type="text" id="set-access-code" maxlength="4" class="w-full bg-white rounded-2xl p-4 text-2xl font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center tracking-[0.5em]" placeholder="â€¢â€¢â€¢â€¢"></div><div class="flex gap-3"><button onclick="closeSecurityModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">å–æ¶ˆ</button><button onclick="saveAccessCode()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">å„²å­˜</button></div></div></div>
    <div id="detail-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity"><div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[85vh] overflow-y-auto no-scrollbar"><div class="w-12 h-1.5 bg-stone-200 rounded-full mx-auto mb-6"></div><div id="detail-content" class="space-y-5"></div><button onclick="closeDetailModal()" class="absolute top-6 right-6 w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button></div></div>
    <div id="edit-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-opacity"><div class="bg-[#FEFDF5] w-full max-w-md rounded-[32px] p-6 shadow-2xl modal-enter relative max-h-[90vh] overflow-y-auto no-scrollbar"><h3 class="text-xl font-bold mb-6 flex justify-between items-center text-[#433D3C]"><span id="modal-title">ç·¨è¼¯è¡Œç¨‹</span><button onclick="closeEditModal()" class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 hover:text-stone-600 tap-effect"><i data-lucide="x" class="w-5 h-5"></i></button></h3><form id="edit-form" class="space-y-4" onsubmit="saveScheduleItem(event)"><input type="hidden" id="edit-day-index"><input type="hidden" id="edit-item-index"><div class="grid grid-cols-2 gap-3"><div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">é–‹å§‹æ™‚é–“</label><input type="time" id="edit-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center"></div><div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">çµæŸæ™‚é–“</label><input type="time" id="edit-end-time" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-stone-500 placeholder-stone-300"></div></div><div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">é¡å‹</label><select id="edit-type" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm appearance-none"><option value="sight">ğŸ“· æ™¯é»</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="shop">ğŸ›ï¸ è³¼ç‰©</option><option value="transport">ğŸšŒ äº¤é€š</option><option value="stay">ğŸ›ï¸ ä½å®¿</option></select></div><div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ¨™é¡Œ</label><input type="text" id="edit-title" required class="w-full bg-white rounded-2xl p-4 text-sm font-bold border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="è¡Œç¨‹åç¨±"></div><div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">åœ°é»</label><div class="relative"><i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400"></i><input type="text" id="edit-location" class="w-full bg-white rounded-2xl p-4 pl-10 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="è¼¸å…¥åœ°é»é—œéµå­—"></div></div><div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label><input type="text" id="edit-tags" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="ä¾‹å¦‚: å¿…åƒ, æ¨è–¦"></div><div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">ç°¡çŸ­å‚™è¨»</label><input type="text" id="edit-note" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm" placeholder="é¡¯ç¤ºåœ¨å¡ç‰‡ä¸Šçš„çŸ­å¥"></div><div class="space-y-1"><label class="text-xs text-stone-500 font-bold ml-1">è©³ç´°ä»‹ç´¹</label><textarea id="edit-description" rows="4" class="w-full bg-white rounded-2xl p-4 text-sm font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm resize-none" placeholder="é€™è£¡è¼¸å…¥çš„å…§å®¹æœƒåŒæ­¥åˆ°è©³ç´°é é¢..."></textarea></div><div class="pt-4"><button type="submit" class="w-full py-4 rounded-2xl bg-[#433D3C] text-[#FEFDF5] font-bold shadow-lg shadow-stone-300 tap-effect">å„²å­˜è®Šæ›´</button></div></form></div></div>
    <div id="date-modal" class="fixed inset-0 bg-[#433D3C]/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity"><div class="bg-[#FEFDF5] w-full max-w-sm rounded-[32px] p-6 shadow-2xl modal-enter relative"><h3 class="text-lg font-bold mb-6 text-[#433D3C] text-center">è¡Œç¨‹è¨­å®š</h3><div class="space-y-4"><div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">æ—…ç¨‹æ¨™é¡Œ</label><input type="text" id="trip-name-input" class="w-full bg-white rounded-2xl p-4 text-lg font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-[#433D3C]"></div><div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">å‡ºç™¼æ—¥æœŸ</label><input type="date" id="start-date-input" class="w-full bg-white rounded-2xl p-4 text-lg font-medium border border-transparent focus:border-stone-200 focus:outline-none shadow-sm text-center text-[#433D3C]"></div><div><label class="text-xs text-stone-500 font-bold ml-1 block mb-2">æ—…è¡Œç¸½å¤©æ•¸</label><div class="flex items-center gap-3 bg-white rounded-2xl p-2 shadow-sm"><button onclick="changeDays(-1)" class="w-10 h-10 rounded-xl bg-stone-100 text-stone-600 flex items-center justify-center font-bold text-xl tap-effect">-</button><input type="number" id="trip-days-input" readonly class="flex-1 text-center text-xl font-bold bg-transparent border-none focus:ring-0 text-[#433D3C]" value="5"><button onclick="changeDays(1)" class="w-10 h-10 rounded-xl bg-stone-100 text-stone-600 flex items-center justify-center font-bold text-xl tap-effect">+</button></div></div></div><p class="text-[10px] text-red-400 text-center mt-6 mb-2">* æ¸›å°‘å¤©æ•¸å°‡æœƒåˆªé™¤å¤šé¤˜æ—¥æœŸçš„è¡Œç¨‹</p><div class="flex gap-3"><button onclick="closeDateModal()" class="flex-1 py-3 rounded-2xl bg-stone-100 text-stone-500 font-bold tap-effect">å–æ¶ˆ</button><button onclick="updateTripSettings()" class="flex-1 py-3 rounded-2xl bg-[#433D3C] text-white font-bold tap-effect shadow-lg shadow-stone-300">ç¢ºèªæ›´æ–°</button></div><hr class="border-stone-200 my-4"><button onclick="deleteCurrentTrip()" class="w-full py-3 rounded-2xl bg-red-50 text-red-500 font-bold tap-effect flex items-center justify-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> åˆªé™¤æ­¤æ—…ç¨‹</button></div></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = { apiKey: "AIzaSyDP1jX1u8TCI3TY8U3xfhEZbaMv9JLgJNw", authDomain: "mytaiwantrip-603c6.firebaseapp.com", projectId: "mytaiwantrip-603c6", storageBucket: "mytaiwantrip-603c6.firebasestorage.app", messagingSenderId: "1063667328708", appId: "1:1063667328708:web:d2ae7acd304e589b790b91" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const provider = new GoogleAuthProvider();

        window.myTrips = JSON.parse(localStorage.getItem('my_trips') || '[]'); window.currentTripId = null; window.isOwner = false; window.currentUser = null; window.tripMeta = {};
        const urlParams = new URLSearchParams(window.location.search); const tripIdFromUrl = urlParams.get('id');
        const indicator = document.getElementById('sync-indicator');
        function showSyncing() { indicator.classList.add('show'); } function hideSyncing() { setTimeout(() => indicator.classList.remove('show'), 800); }

        window.toggleUserMenu = () => document.getElementById('user-menu').classList.toggle('show');
        document.addEventListener('click', (e) => { if (!document.getElementById('user-menu').contains(e.target) && !document.getElementById('user-avatar').contains(e.target)) document.getElementById('user-menu').classList.remove('show'); });
        window.handleLogin = async () => { try { await signInWithPopup(auth, provider); document.getElementById('user-menu').classList.remove('show'); } catch (e) { console.error(e); alert("ç™»å…¥å¤±æ•—: " + e.message); } };
        window.handleLogout = async () => { await signOut(auth); await signInAnonymously(auth); window.location.reload(); };

        async function syncUserTrips(user) { if (!user || user.isAnonymous) return; const ref = doc(db, 'artifacts', 'travel_app_v2', 'users', user.uid, 'data', 'profile'); let cloud = []; try { const s = await getDoc(ref); if(s.exists()) cloud=s.data().ids||[]; } catch(e){} const all = [...new Set([...cloud, ...window.myTrips])]; if(all.length > cloud.length) await setDoc(ref, { ids: all }, { merge: true }); window.myTrips = all; localStorage.setItem('my_trips', JSON.stringify(window.myTrips)); if (!window.currentTripId) window.renderDashboard(); }
        window.saveTripMetadata = async (id, name, date, days, accessCode, allowedEmails, newOwnerId) => { if (!auth.currentUser) return; const data = { name, date, days }; if(newOwnerId) data.ownerId = newOwnerId; else if(!window.tripMeta.ownerId && auth.currentUser.uid) data.ownerId = auth.currentUser.uid; if (accessCode !== undefined) data.accessCode = accessCode; if (allowedEmails !== undefined) data.allowedEmails = allowedEmails; await setDoc(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', id), { meta: data }, { merge: true }); };
        // Corrected path to match RULE 1: artifacts/appId/public/data/collection
        // Actually, to keep it simple and compliant, we store everything under artifacts/travel_app_v2/public/data/trips/{tripId}
        // But subcollections are needed. Firestore allows subcollections under a doc.
        // Path: artifacts/travel_app_v2/public/data/trips/{tripId} -> doc
        // Subcollection: artifacts/travel_app_v2/public/data/trips/{tripId}/data/{type} -> doc
        window.saveTripData = async (tripId, type, data) => { if (!auth.currentUser) return; showSyncing(); await setDoc(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', tripId, 'data', type), { items: data }); hideSyncing(); };
        
        window.checkAccess = (meta) => {
            const user = auth.currentUser;
            if (user && meta.ownerId === user.uid) return true;
            if (user && !user.isAnonymous && meta.allowedEmails && meta.allowedEmails.includes(user.email)) return true;
            if (sessionStorage.getItem(`unlocked_${window.currentTripId}`) === 'true') return true;
            if (meta.accessCode) { document.getElementById('lock-screen').classList.add('active'); return false; }
            if ((meta.allowedEmails && meta.allowedEmails.length > 0) || meta.ownerId) {
                document.getElementById('current-user-email-display').innerText = user && !user.isAnonymous ? user.email : "æœªç™»å…¥ (è¨ªå®¢)";
                if (!meta.ownerId) document.getElementById('claim-btn').classList.remove('hidden'); else document.getElementById('claim-btn').classList.add('hidden');
                document.getElementById('access-denied-screen').classList.add('active');
                return false;
            }
            return true;
        };
        
        window.verifyAccessCode = () => { if (document.getElementById('access-code-input').value === window.tripMeta.accessCode) { sessionStorage.setItem(`unlocked_${window.currentTripId}`, 'true'); document.getElementById('lock-screen').classList.remove('active'); document.getElementById('view-app').classList.remove('hidden'); loadSubCollections(window.currentTripId); window.renderTripView(); } else { alert("å¯†ç¢¼éŒ¯èª¤"); } };
        window.claimOwnership = async () => { if(!auth.currentUser) return alert("è«‹å…ˆç™»å…¥"); if(confirm("ç¢ºå®šè¦èªé ˜ï¼Ÿ")) { await setDoc(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', window.currentTripId), { meta: { ownerId: auth.currentUser.uid } }, { merge: true }); alert("èªé ˜æˆåŠŸ"); window.location.reload(); } };
        
        window.inviteUser = async () => { const email = document.getElementById('invite-email-input').value.trim(); if (!email) return; const current = window.tripMeta.allowedEmails || []; if (!current.includes(email)) { const news = [...current, email]; await setDoc(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', window.currentTripId), { meta: { allowedEmails: news } }, { merge: true }); window.tripMeta.allowedEmails = news; renderShareList(); } document.getElementById('invite-email-input').value = ''; };
        window.removeUser = async (email) => { if(!confirm(`ç§»é™¤ ${email}ï¼Ÿ`)) return; const current = window.tripMeta.allowedEmails || []; const news = current.filter(e => e !== email); await setDoc(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', window.currentTripId), { meta: { allowedEmails: news } }, { merge: true }); window.tripMeta.allowedEmails = news; renderShareList(); };

        onAuthStateChanged(auth, (user) => { if (user) { window.currentUser = user; if(!user.isAnonymous) { document.getElementById('user-img').src = user.photoURL; document.getElementById('user-img').classList.remove('hidden'); document.getElementById('user-avatar').classList.add('logged-in'); document.getElementById('user-info').innerText = user.email; document.getElementById('user-info').classList.remove('hidden'); document.getElementById('btn-login').classList.add('hidden'); document.getElementById('btn-logout').classList.remove('hidden'); syncUserTrips(user); } } else { signInAnonymously(auth); } if(tripIdFromUrl) loadTrip(tripIdFromUrl); else window.renderDashboard(); });

        window.loadTrip = async (tripId) => {
            window.currentTripId = tripId;
            if(!window.myTrips.includes(tripId)) { window.myTrips.push(tripId); localStorage.setItem('my_trips', JSON.stringify(window.myTrips)); }
            document.getElementById('view-home').classList.add('hidden');
            onSnapshot(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', tripId), (docSnap) => {
                if(docSnap.exists()) {
                    window.tripMeta = docSnap.data().meta || {};
                    window.isOwner = (auth.currentUser && window.tripMeta.ownerId === auth.currentUser.uid);
                    const lockIcon = document.getElementById('header-lock-icon');
                    if (window.tripMeta.accessCode) { lockIcon.setAttribute('data-lucide', 'lock'); lockIcon.classList.add('text-red-400'); } else { lockIcon.setAttribute('data-lucide', 'unlock'); lockIcon.classList.remove('text-red-400'); }
                    lucide.createIcons();
                    renderShareList();
                    if (window.checkAccess(window.tripMeta)) { document.getElementById('view-app').classList.remove('hidden'); document.getElementById('header-trip-title').innerText = window.tripMeta.name || "æœªå‘½åæ—…ç¨‹"; loadSubCollections(tripId); }
                } else {
                    // If trip doesn't exist, assume it's a new one or deleted.
                    // For dashboard, we might just hide it. For direct link, show error?
                    // Or creating default if missing... but wait, this is a public DB, we shouldn't overwrite easily.
                    // Let's just init default data if it's the *default* ID, else do nothing.
                    if(tripId.startsWith('default_taiwan')) {
                         window.saveToFirestore('schedule', window.defaultScheduleData);
                    }
                }
            });
        };
        function loadSubCollections(tripId) { 
            onSnapshot(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', tripId, 'data', 'schedule'), (s) => { if (s.exists()) { window.scheduleData = s.data().items; window.renderTripView(); } }); 
            onSnapshot(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', tripId, 'data', 'expenses'), (s) => { window.expenses = s.exists()?s.data().items:[]; window.renderExpenses(); }); 
            onSnapshot(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', tripId, 'data', 'companions'), (s) => { window.companions = s.exists()?s.data().items:["æˆ‘"]; window.updatePayerSelect(); window.renderShareButtons(); window.renderFilter(); }); 
        }
        function renderShareList() { const c = document.getElementById('access-list-container'); const ems = window.tripMeta.allowedEmails || []; let h = `<div class="flex justify-between items-center bg-stone-50 p-2 rounded-lg mb-2"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-[#433D3C] text-white flex items-center justify-center text-xs">O</div><span class="text-xs font-bold text-stone-600">æ“æœ‰è€…</span></div></div>`; ems.forEach(e => { h += `<div class="flex justify-between items-center bg-white border border-stone-100 p-2 rounded-lg mb-1"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center text-xs">${e[0].toUpperCase()}</div><span class="text-xs text-stone-600">${e}</span></div>${window.isOwner ? `<button onclick="removeUser('${e}')" class="text-stone-300 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button>` : ''}</div>`; }); if(ems.length===0) h+=`<div class="text-center text-xs text-stone-300 py-2">é‚„æ²’æœ‰é‚€è«‹ä»»ä½•äºº</div>`; c.innerHTML = h; lucide.createIcons(); }
        window.renderTripView = () => { if (!document.getElementById('lock-screen').classList.contains('active') && !document.getElementById('access-denied-screen').classList.contains('active')) { window.renderDaySelector(); window.renderTimeline(window.currentDayIndex); fetchWeather(window.scheduleData[window.currentDayIndex]); } };
        
        // Explicitly attach openShareModal to window for button onclick
        window.openShareModal = function() {
            if(!window.currentTripId) return;
            const url = window.location.origin + window.location.pathname + '?id=' + window.currentTripId;
            document.getElementById('share-link-text').innerText = url; // Only for manual copy
            renderShareList();
            document.getElementById('share-modal').classList.remove('hidden');
        };
        window.closeShareModal = () => document.getElementById('share-modal').classList.add('hidden');
        window.copyShareLink = function() {
            const url = document.getElementById('share-link-text').innerText;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => alert("é€£çµå·²è¤‡è£½"));
            } else { prompt("è«‹è¤‡è£½é€£çµï¼š", url); }
        }
        window.shareViaGmail = function() {
            const url = document.getElementById('share-link-text').innerText;
            const tripName = window.tripMeta.name || "æ—…éŠè¡Œç¨‹";
            const subject = encodeURIComponent(`[é‚€è«‹] ä¸€èµ·ä¾†è¦åŠƒ ${tripName} å§ï¼`);
            let bodyText = `Hi,\n\næˆ‘æ­£åœ¨ä½¿ç”¨æ—…éŠå°å¹«æ‰‹è¦åŠƒ ${tripName}ï¼Œé‚€è«‹ä½ ä¸€èµ·åŠ å…¥ç·¨è¼¯ï¼\n\nğŸ”— è¡Œç¨‹é€£çµï¼š\n${url}`;
            if(window.tripMeta.accessCode) bodyText += `\n\nğŸ”‘ é€šè¡Œç¢¼ï¼š${window.tripMeta.accessCode}`;
            const body = encodeURIComponent(bodyText);
            window.open(`https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`, '_blank');
            window.closeShareModal();
        }
        
        // (Rest of logic for dashboard, create, delete, expenses, etc.)
        window.renderDashboard = async () => {
            if(tripIdFromUrl) return;
            const container = document.getElementById('trip-list-container');
            container.innerHTML = '';
            if (window.myTrips.length === 0) { container.innerHTML = `<div class="text-center text-stone-400 mt-20 flex flex-col items-center"><i data-lucide="map" class="w-12 h-12 mb-4 opacity-50"></i><p class="text-lg font-bold">é‚„æ²’æœ‰æ—…ç¨‹</p><p class="text-sm mt-2">é»æ“Šå³ä¸Šè§’çš„ã€Œ+ã€é–‹å§‹è¦åŠƒ</p></div>`; lucide.createIcons(); return; }
            let html = '';
            for(const id of window.myTrips) {
                const docSnap = await getDoc(doc(db, 'artifacts', 'travel_app_v2', 'public', 'data', 'trips', id));
                if(docSnap.exists()) {
                    const meta = docSnap.data().meta || { name: 'æœªå‘½å', date: '?', days: '?' };
                    const isLocked = meta.accessCode ? true : false; const isPrivate = (meta.allowedEmails && meta.allowedEmails.length > 0);
                    let badge = ''; if(isLocked) badge = '<i data-lucide="lock" class="w-3 h-3 text-stone-300"></i>'; if(isPrivate) badge += '<i data-lucide="users" class="w-3 h-3 text-blue-300 ml-1"></i>';
                    html += `<div onclick="loadTrip('${id}')" class="bg-white rounded-[24px] p-5 zen-shadow relative overflow-hidden card-clickable group border border-white mb-4"><div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-stone-100 to-transparent rounded-bl-full opacity-50"></div><div class="relative z-10"><div class="flex justify-between items-start mb-2"><span class="text-[10px] font-bold text-stone-400 tracking-widest uppercase flex items-center gap-1">TRIP ${badge}</span><button onclick="deleteTrip(event, '${id}')" class="text-stone-300 hover:text-red-400 p-1 -mr-2 -mt-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><h2 class="text-2xl font-bold text-[#433D3C] mb-1">${meta.name}</h2><div class="flex items-center gap-2 text-stone-500 text-xs font-bold"><i data-lucide="calendar" class="w-3 h-3"></i><span>${meta.date}</span><span class="w-1 h-1 rounded-full bg-stone-300"></span><span>${meta.days} Days</span></div></div></div>`;
                }
            }
            container.innerHTML = html; lucide.createIcons();
        };
        window.createNewTrip = async () => { const name = prompt("è«‹è¼¸å…¥æ–°æ—…ç¨‹åç¨±:"); if(!name) return; const newId = 'trip_' + Date.now().toString(36); const today = new Date().toISOString().split('T')[0]; const initialEmails = (auth.currentUser && !auth.currentUser.isAnonymous) ? [auth.currentUser.email] : []; const ownerId = auth.currentUser ? auth.currentUser.uid : null; await window.saveTripMetadata(newId, name, today, 3, null, initialEmails, ownerId); const initialSchedule = Array(3).fill().map((_, i) => ({ date: "", month: "", day: `Day ${i+1}`, items: [] })); await window.saveTripData(newId, 'schedule', initialSchedule); await window.saveTripData(newId, 'expenses', []); await window.saveTripData(newId, 'companions', ["æˆ‘"]); window.loadTrip(newId); };
        window.deleteCurrentTrip = async function() { if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return; window.myTrips = window.myTrips.filter(id => id !== window.currentTripId); localStorage.setItem('my_trips', JSON.stringify(window.myTrips)); window.closeDateModal(); window.backToHome(); };
        const securityModal = document.getElementById('security-modal');
        window.openSecurityModal = function() { if(!window.isOwner) return alert("æ¬Šé™ä¸è¶³"); document.getElementById('set-access-code').value = window.tripMeta.accessCode || ''; securityModal.classList.remove('hidden'); }
        window.closeSecurityModal = function() { securityModal.classList.add('hidden'); }
        window.saveAccessCode = async function() { const c = document.getElementById('set-access-code').value; await window.saveTripMetadata(window.currentTripId, window.tripMeta.name, window.tripMeta.date, window.tripMeta.days, c || null, window.tripMeta.allowedEmails); window.closeSecurityModal(); alert("è¨­å®šå·²æ›´æ–°"); };
    </script>

    <script>
        // --- UI Logic ---
        const EXCHANGE_RATE = 0.24;
        const WEATHER_ICONS = { 0: 'sun', 1: 'cloud-sun', 2: 'cloud-sun', 3: 'cloud', 45: 'cloud-fog', 48: 'cloud-fog', 51: 'cloud-drizzle', 53: 'cloud-drizzle', 55: 'cloud-drizzle', 61: 'cloud-rain', 63: 'cloud-rain', 65: 'cloud-rain', 71: 'snowflake', 73: 'snowflake', 75: 'snowflake', 80: 'cloud-rain-wind', 81: 'cloud-rain-wind', 82: 'cloud-rain-wind', 95: 'cloud-lightning', 96: 'cloud-lightning', 99: 'cloud-lightning' };
        window.defaultScheduleData = [
            { date: "27", month: "12", day: "Day 1", items: [{ time: "08:00", endTime: "10:00", title: "æŠµé”è½æ©Ÿ", type: "transport", location: "å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", note: "è³¼è²·æ‚ éŠå¡/SIMå¡", description: "æ©Ÿå ´æ·é‹ç›´é”è»Šç´„35-40åˆ†é˜å¯æŠµé”å°åŒ—è»Šç«™ã€‚è¨˜å¾—åœ¨æ©Ÿå ´å…ˆæ›å¥½å°å¹£ï¼Œæˆ–ä½¿ç”¨ATMææ¬¾ã€‚" }, { time: "11:00", endTime: "12:00", title: "æ°‘å®¿æ“ºè¡Œæ", type: "stay", location: "å°åŒ—", note: "å¯„æ”¾è¡Œæ", description: "å…ˆå°‡è¡Œæå¯„æ”¾ï¼Œè¼•è£ä¸Šé™£é–‹å§‹è¡Œç¨‹ã€‚" }, { time: "13:00", endTime: "14:30", title: "ç¨‹å‘³çæ„éºµæ»·å‘³", type: "food", location: "ç¨‹å‘³çæ„éºµ", tags: ["å¿…åƒæ»·å‘³"], note: "40å¹´è€åº—", description: "è¥¿é–€ç”ºè€å­—è™Ÿï¼Œæ»·å‘³éå¸¸å…¥å‘³ï¼Œå¿…é»æ»·è˜¿è””ã€å¤§è±†å¹²å’Œæ„éºµã€‚æ»·æ±å¸¶é»ç”œå‘³ï¼Œéå¸¸é–‹èƒƒã€‚" }, { time: "15:00", endTime: "16:30", title: "è¥¿é–€ç”º", type: "sight", location: "è¥¿é–€ç”º", tags: ["é€›è¡—"], note: "å¹´è¼•äººé›†æ•£åœ°", description: "å°åŒ—æ½®æµä¸­å¿ƒï¼Œå¿…é€›å”å‰è¨¶å¾·ã€è¬å¹´å¤§æ¨“ã€‚æ¨è–¦å°åƒï¼šé˜¿å®—éºµç·šã€å¤©å¤©åˆ©ç¾é£ŸåŠã€‚" }, { time: "17:00", endTime: "18:30", title: "å¦³æœ‰å’–å•¡ neo cafe", type: "food", location: "å¦³æœ‰å’–å•¡ neo cafe", tags: ["å’–å•¡", "Pizza"], note: "éš±è—ç‰ˆå’–å•¡å»³", description: "ä½æ–¼äºŒæ¨“çš„å¾©å¤é¢¨å’–å•¡å»³ï¼Œç’°å¢ƒèˆ’é©ã€‚æ¨è–¦å˜—è©¦ä»–å€‘çš„ã€Œå¤§äººå‘³ç„¦ç³–å¸ƒä¸ã€å’Œç‰¹è‰²å£å‘³Pizzaã€‚" }, { time: "19:00", endTime: "20:30", title: "è©¹è¨˜éº»è¾£ç«é‹", type: "food", location: "è©¹è¨˜éº»è¾£ç«é‹ è¥¿é–€å¤§ä¸–ç•Œ", tags: ["å¿…åƒé´¨è¡€", "éœ€è¨‚ä½"], note: "å°åŒ—æœ€é›£è¨‚", description: "å¾©å¤å°å¼è£æ½¢ï¼Œé´¨è¡€å£æ„Ÿåƒæœå‡ä¸€æ¨£æ»‘å«©ï¼è¨˜å¾—é»æ²¹æ¢å¸æ»¿æ¹¯æ±ã€‚" }, { time: "21:00", endTime: "22:30", title: "å—æ©Ÿå ´å¤œå¸‚", type: "food", location: "å—æ©Ÿå ´å¤œå¸‚", tags: ["åœ¨åœ°ç¾é£Ÿ"], note: "CPå€¼é«˜", description: "é›–ç„¡æ·é‹ç›´é”ä½†æ·±å—åœ¨åœ°äººå–œæ„›ã€‚æ¨è–¦ï¼šå±±å…§é›è‚‰ã€è‡­è€é—†ç¾è’¸è‡­è±†è…ã€å…«æ£Ÿåœ“ä»”æ¹¯ã€‚" }] },
            { date: "28", month: "12", day: "Day 2", items: [{ time: "09:00", endTime: "10:00", title: "æ—©é¤", type: "food", location: "å°åŒ—", note: "é™„è¿‘æ—©é¤åº—", description: "æ‰¾é–“å‚³çµ±è±†æ¼¿åº—æˆ–è›‹é¤…åº—é–‹å•Ÿä¸€å¤©ã€‚" }, { time: "12:00", endTime: "15:30", title: "ä¹ä»½åä»½", type: "sight", location: "ä¹ä»½è€è¡—", tags: ["å±±åŸ", "ç‡ˆç± "], note: "ç¥éš±å°‘å¥³å ´æ™¯", description: "å»ºè­°å…ˆå»ååˆ†ç€‘å¸ƒå’Œæ”¾å¤©ç‡ˆï¼Œå‚æ™šå†åˆ°ä¹ä»½è€è¡—çœ‹å¤œæ™¯ã€‚å¿…åƒï¼šé˜¿æŸ‘å§¨èŠ‹åœ“ã€é˜¿è˜­è‰ä»”ç²¿ã€‚" }, { time: "16:00", endTime: "17:30", title: "çŒ´ç¡è²“æ‘", type: "sight", location: "çŒ´ç¡è²“æ‘", tags: ["è²“å’ª", "ç…¤ç¤¦"], note: "CNNæ¨è–¦", description: "è²“å¥´å¤©å ‚ï¼Œè«‹å‹¿å°è²“å’ªé–‹é–ƒå…‰ç‡ˆã€‚ä¹Ÿå¯åƒè§€é¡˜æ™¯é¤¨äº†è§£ç…¤ç¤¦æ­·å²ã€‚" }, { time: "19:00", endTime: "20:30", title: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰", type: "food", location: "å¤§è‚¡ç†Ÿæˆç‡’è‚‰å°ˆé–€ å°åŒ—å—äº¬åº—", tags: ["åšåˆ‡ç‰›èˆŒ"], note: "æ¸…é…’è²©è³£æ©Ÿ", description: "å…¨ç¨‹å°ˆäººä»£çƒ¤ï¼Œå¿…ç©åº—å…§çš„æ¸…é…’æŠ•å¹£æ©Ÿï¼Œåšåˆ‡ç‰›èˆŒå£æ„Ÿæ¥µä½³ã€‚" }, { time: "22:00", endTime: "23:30", title: "å¯§å¤å¤œå¸‚", type: "food", location: "å¯§å¤å¤œå¸‚", tags: ["ç±³å…¶æ—æ¨è–¦"], note: "è·¯å¯¬å¥½é€›", description: "å‹•ç·šå–®ç´”ï¼Œç¾é£Ÿé›†ä¸­ã€‚å¿…åƒï¼šåŠ‰èŠ‹ä»”è›‹é»ƒèŠ‹é¤…(å¿…æ’)ã€åœ“ç’°é‚Šèšµä»”ç…ã€è±¬è‚æ¦®ä»”ã€‚" }] },
            { date: "29", month: "12", day: "Day 3", items: [{ time: "11:00", endTime: "12:30", title: "çŠåœ’æ¹¯åŒ…é¤¨", type: "food", location: "çŠåœ’æ¹¯åŒ…é¤¨", tags: ["çµ²ç“œæ¹¯åŒ…"], note: "å¹³åƒ¹é¼æ³°è±", description: "å¿…é»çµ²ç“œè¦ä»æ¹¯åŒ…ï¼Œæ¸…çˆ½é®®ç”œã€‚ç¾…å‹’é®®èšµæ¹¯åŒ…ä¹Ÿå¾ˆæœ‰ç‰¹è‰²ï¼Œæµæ²™åŒ…ç•¶ç”œé»å¾ˆæ£’ã€‚" }, { time: "14:00", endTime: "15:00", title: "ä¸‰å‰µç”Ÿæ´»åœ’å€", type: "sight", location: "ä¸‰å‰µç”Ÿæ´»åœ’å€", tags: ["3C", "å‹•æ¼«"], note: "ç§‘æŠ€å•†å ´", description: "å„æ¨“å±¤ä¸»é¡Œé®®æ˜ï¼Œå‹•æ¼«è¿·èˆ‡3Cæ§å¿…é€›ã€‚æ—é‚Šå°±æ˜¯å…‰è¯å•†å ´ã€‚" }, { time: "15:00", endTime: "17:00", title: "è¯å±±1914", type: "sight", location: "è¯å±±1914æ–‡åŒ–å‰µæ„ç”¢æ¥­åœ’å€", tags: ["å±•è¦½", "æ‹ç…§"], note: "æ–‡é’èšé›†åœ°", description: "èˆŠé…’å» æ”¹å»ºï¼Œå……æ»¿æ–‡è—æ°£æ¯ï¼Œå¸¸æœ‰ç‰¹è‰²ç‰¹å±•èˆ‡å¸‚é›†ï¼Œå¤§è‰çš®é©åˆä¼‘æ¯ã€‚" }, { time: "17:00", endTime: "18:00", title: "å¸•ç±³è²å¯", type: "shop", location: "å¸•ç±³è²å¯", tags: ["ä¼´æ‰‹ç¦®", "è´è¶é…¥"], note: "åƒå±¤é…¥è„†", description: "éå¸¸æœ‰åçš„åƒå±¤è´è¶é…¥ï¼Œé…¥è„†ä¸ç”œè†©ï¼Œé©åˆè²·å›é¦™æ¸¯é€ç¦®ã€‚" }, { time: "19:00", endTime: "20:30", title: "æ‹¾æ¼", type: "food", location: "æ‹¾æ¼ æ°¸åº·åº—", tags: ["æ—¥å¼ç„¡èœå–®"], note: "é«˜CPå€¼", description: "é£Ÿææ–°é®®ï¼ŒCPå€¼å¾ˆé«˜çš„ç„¡èœå–®æ–™ç†ï¼Œéœ€æº–æ™‚å…¥å¸­ã€‚" }, { time: "21:00", endTime: "22:30", title: "é¥’æ²³å¤œå¸‚", type: "food", location: "é¥’æ²³è¡—è§€å…‰å¤œå¸‚", tags: ["ç±³å…¶æ—å¿…æ¯”ç™»"], note: "è—¥ç‡‰æ’éª¨", description: "å…¥å£è™•çš„ã€Œç¦å·ä¸–ç¥–èƒ¡æ¤’é¤…ã€å¿…æ’ï¼Œé™³è‘£è—¥ç‡‰æ’éª¨å†¬å¤©åƒæœ€æš–èƒƒã€‚" }] },
            { date: "30", month: "12", day: "Day 4", items: [{ time: "12:00", endTime: "13:30", title: "æ¯”æ¼¾å»£å ´", type: "shop", location: "æ¯”æ¼¾å»£å ´", tags: ["ç™¾è²¨"], note: "æ°¸å’Œåœ¨åœ°", description: "æ°¸å’Œåœ¨åœ°çš„ç™¾è²¨å…¬å¸ï¼Œé©åˆæ‚ é–’é€›è¡—æˆ–ç”¨é¤ã€‚" }, { time: "14:00", endTime: "15:30", title: "æ¨‚è¯å•†åœˆ", type: "sight", location: "æ¨‚è¯å¤œå¸‚", tags: ["åœ¨åœ°å¤œå¸‚"], note: "è·¯å¯¬å¥½é€›", description: "é›–ç„¶æ˜¯å¤œå¸‚ï¼Œä¸‹åˆä¹Ÿæœ‰ä¸å°‘åº—å®¶ã€‚æ¨è–¦ï¼šéƒ­è¨˜éº»è¾£è‡­è±†è…ã€æ°¸ç¾é›ªèŠ±å†°ã€‚" }, { time: "16:00", endTime: "17:00", title: "Chii! Gelato", type: "food", location: "Chii! Gelato", tags: ["ç¾©å¼å†°æ·‡æ·‹"], note: "å¤©ç„¶æ¿ƒéƒ", description: "å£å‘³éå¸¸é“åœ°ï¼Œæ¨è–¦é–‹å¿ƒæœå£å‘³ï¼Œæ°´æœç³»åˆ—ä¹Ÿå¾ˆæ¸…çˆ½ã€‚" }, { time: "19:00", endTime: "20:30", title: "é‡‘æœˆæ—¥æœ¬é‹", type: "food", location: "é‡‘æœˆæ—¥æœ¬é‹æ–™ç†æ“”ç•¶", tags: ["æ¸…é…’æ¹¯åº•"], note: "é ‚ç´šé‹ç‰©", description: "ä»¥æ¸…é…’å…¥æ¹¯æ˜¯ä¸€å¤§ç‰¹è‰²ï¼Œå°ˆäººæ¡Œé‚Šæœå‹™ï¼Œç…®æµ·é®®å’Œå’Œç‰›éƒ½éå¸¸é®®ç”œã€‚" }, { time: "21:00", endTime: "22:30", title: "è‡¨æ±Ÿè¡—å¤œå¸‚", type: "food", location: "è‡¨æ±Ÿè¡—è§€å…‰å¤œå¸‚", tags: ["é€šåŒ–å¤œå¸‚"], note: "å¸‚å€æ–¹ä¾¿", description: "æ¨è–¦ï¼šå¾¡å“å…ƒå†°ç«æ¹¯åœ“(å¿…åƒ)ã€ç´…èŠ±éº»è¾£é¹½æ°´é›ã€æ¢è¨˜æ»·å‘³ã€‚" }] },
            { date: "31", month: "12", day: "Day 5", items: [{ time: "12:00", endTime: "12:30", title: "Check Out", type: "stay", location: "å°åŒ—", note: "æª¢æŸ¥è¡Œæ", description: "æœ€å¾Œä¸€å¤©ï¼Œç¢ºèªæ±è¥¿éƒ½å¸¶é½Šäº†å—ï¼Ÿ" }, { time: "14:00", endTime: "17:00", title: "è¯æ³°åå“åŸ", type: "shop", location: "GLORIA OUTLETS è¯æ³°åå“åŸ", tags: ["Outlet"], note: "æœ€å¾Œè¡åˆº", description: "ä½æ–¼æ¡ƒåœ’é«˜éµæ—ï¼Œç¾å¼éœ²å¤©Outletï¼Œå„å¤§åœ‹éš›ç²¾å“æŠ˜æ‰£å¤šï¼Œå›æ¸¯å‰æœ€å¾Œè¡åˆºã€‚" }, { time: "19:00", endTime: "20:00", title: "æ™šé¤", type: "food", location: "æ¡ƒåœ’æ©Ÿå ´/é«˜éµç«™", note: "ç°¡å–®ç”¨é¤", description: "åœ¨æ©Ÿå ´æˆ–é«˜éµç«™é™„è¿‘ç°¡å–®ç”¨é¤ï¼Œæº–å‚™ç™»æ©Ÿã€‚" }, { time: "22:00", endTime: "23:00", title: "å›é¦™æ¸¯", type: "transport", location: "æ¡ƒåœ’æ©Ÿå ´", note: "ææ—©å ±åˆ°", description: "å»ºè­°ææ—© 2.5 å°æ™‚æŠµé”æ©Ÿå ´è¾¦ç†ç™»æ©Ÿèˆ‡é€€ç¨…ã€‚" }] }
        ];

        window.scheduleData = [];
        window.currentDayIndex = 0;
        window.expenses = [];
        window.companions = ["æˆ‘"];
        window.currentFilter = 'ALL';

        function init() {
            lucide.createIcons();
            document.getElementById('expense-amount').addEventListener('input', function(e) {
                const val = parseInt(e.target.value) || 0;
                document.getElementById('input-hkd-preview').innerText = Math.round(val * EXCHANGE_RATE);
            });
        }

        window.backToHome = function() {
            const newUrl = window.location.origin + window.location.pathname;
            window.history.pushState({path:newUrl},'',newUrl);
            document.getElementById('view-app').classList.add('hidden');
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('lock-screen').classList.remove('active');
            document.getElementById('access-denied-screen').classList.remove('active');
            window.currentTripId = null;
            window.renderDashboard();
        };
        
        async function fetchWeather(dayObj) {
            const container = document.getElementById('hourly-weather-container');
            const title = document.getElementById('weather-title');
            if (!dayObj || !dayObj.month || !dayObj.date) {
                container.innerHTML = '<div class="w-full text-center text-stone-300 py-4 text-xs">æ—¥æœŸæœªè¨­å®š</div>';
                return;
            }
            
            const year = new Date().getFullYear();
            const m = dayObj.month.toString().padStart(2, '0');
            const d = dayObj.date.toString().padStart(2, '0');
            const tripDateStr = `${year}-${m}-${d}`;
            const tripDate = new Date(tripDateStr);
            const today = new Date();
            const diffTime = tripDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            const lat = 25.0330, lon = 121.5654;
            let apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code&timezone=auto`;

            if (diffDays >= -1 && diffDays <= 6) {
                 apiUrl += `&start_date=${tripDateStr}&end_date=${tripDateStr}`;
                 title.innerText = `é å ± (${dayObj.month}/${dayObj.date})`;
            } else {
                title.innerText = `å°åŒ—å³æ™‚å¤©æ°£ (è¡Œç¨‹è¼ƒé )`;
                apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code&timezone=auto&forecast_days=1`;
            }

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (diffDays <= 1 && diffDays >= -1 && data.hourly) {
                     const currentHour = new Date().getHours();
                     const t = Math.round(data.hourly.temperature_2m[currentHour] || data.hourly.temperature_2m[0]);
                     document.getElementById('header-temp').innerText = `${t}Â°C`;
                }

                let html = '';
                if(!data.hourly) throw new Error("No data");

                data.hourly.time.forEach((timeStr, index) => {
                    const date = new Date(timeStr);
                    const hour = date.getHours();
                    if (hour >= 6 && hour <= 23) {
                        const temp = Math.round(data.hourly.temperature_2m[index]);
                        const code = data.hourly.weather_code[index];
                        const icon = WEATHER_ICONS[code] || 'cloud'; 
                        html += `<div class="weather-scroll-item flex flex-col items-center justify-center bg-stone-50 rounded-xl py-2 px-1 snap-start min-w-[60px]"><span class="text-[10px] text-stone-400 font-mono mb-1">${hour.toString().padStart(2, '0')}:00</span><i data-lucide="${icon}" class="w-5 h-5 text-stone-600 mb-1"></i><span class="text-xs font-bold text-stone-800">${temp}Â°</span></div>`;
                    }
                });
                container.innerHTML = html;
                lucide.createIcons();
            } catch (e) {
                console.error("Weather API Error:", e);
                container.innerHTML = '<div class="w-full text-center text-stone-300 py-4 text-xs">æš«æ™‚ç„¡æ³•å–å¾—å¤©æ°£</div>';
            }
        }

        init();
        const style = document.createElement('style');
        style.innerHTML = `@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.4s ease-out; } .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1); }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
